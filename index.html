<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panexpress SPR Tracker - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <!-- Logo and Title -->
            <div class="text-center fade-in">
                <div class="mx-auto h-20 w-20 bg-blue-600 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Panexpress SPR Tracker</h1>
                <p class="text-gray-600">Secure access to your logistics dashboard</p>
                <div class="mt-4 flex items-center justify-center text-sm text-green-600">
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2 pulse-dot"></div>
                    System Ready
                </div>
            </div>

            <!-- Login Form -->
            <div class="bg-white rounded-xl shadow-lg p-8 fade-in">
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="username" name="username" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            placeholder="Enter your username">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="password" name="password" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors pr-12"
                                placeholder="Enter your password">
                            <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="rememberMe" name="rememberMe" 
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="rememberMe" class="ml-2 block text-sm text-gray-700">Remember me</label>
                        </div>
                        <button type="button" onclick="showForgotPassword()" class="text-sm text-blue-600 hover:text-blue-500">
                            Forgot password?
                        </button>
                    </div>

                    <button type="submit" id="loginButton" 
                        class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium transition-colors">
                        <span id="loginText">Sign In</span>
                        <svg id="loginSpinner" class="hidden animate-spin -mr-1 ml-3 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>


            </div>

            <!-- Footer -->
            <div class="text-center text-sm text-gray-500">
                <p>© 2024 Panexpress SPR Tracker</p>
                <p class="mt-1">Secure • Reliable • Professional</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden bg-gray-50 min-h-screen">
        <header class="bg-white shadow-lg border-b-4 border-blue-600">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <div class="bg-blue-600 text-white p-3 rounded-lg mr-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Panexpress SPR Tracker</h1>
                            <p class="text-sm text-gray-600">🚀 Live Database Connected</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <nav class="flex space-x-6">
                            <button onclick="showDashboard()" class="px-4 py-2 text-gray-600 hover:text-blue-600 font-medium transition-colors">Dashboard</button>
                            <button onclick="showRequestForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors">Request SPR</button>
                            <button onclick="showViewSprs()" class="px-4 py-2 text-gray-600 hover:text-blue-600 font-medium transition-colors">View SPRs</button>
                            <button id="dataManagementBtn" onclick="showDataManagement()" class="px-4 py-2 text-gray-600 hover:text-blue-600 font-medium transition-colors hidden">Data Management</button>
                        </nav>
                        <div class="flex items-center space-x-4">
                            <div id="dataStatus" class="text-sm font-medium">
                                <div class="flex items-center text-green-600">
                                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2 pulse-dot"></div>
                                    Connected to Supabase
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm font-bold" id="userInitial">A</span>
                                </div>
                                <div class="text-sm">
                                    <div class="font-medium text-gray-900" id="currentUser">Admin User</div>
                                    <div class="text-gray-500" id="userRole">Administrator</div>
                                </div>
                                <button onclick="logout()" class="ml-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                                    🚪 Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <div id="dashboard" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
                        <div class="flex space-x-3">
                            <button id="backupBtn" onclick="dataManager.exportFullBackup()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm hidden">
                                📥 Backup Data
                            </button>
                            <button onclick="dataManager.syncPendingChanges()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                🔄 Refresh Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-600">
                            <h3 class="text-lg font-semibold text-blue-900">Total SPRs</h3>
                            <p class="text-3xl font-bold text-blue-600 mt-2" id="totalSprs">0</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg border-l-4 border-green-600">
                            <h3 class="text-lg font-semibold text-green-900">Completed</h3>
                            <p class="text-3xl font-bold text-green-600 mt-2" id="completedSprs">0</p>
                        </div>
                        <div class="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-600">
                            <h3 class="text-lg font-semibold text-yellow-900">Pending</h3>
                            <p class="text-3xl font-bold text-yellow-600 mt-2" id="pendingSprs">0</p>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-lg border-l-4 border-purple-600">
                            <h3 class="text-lg font-semibold text-purple-900">System Version</h3>
                            <p class="text-3xl font-bold text-purple-600 mt-2">v33</p>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
                        <div id="recentActivity" class="space-y-3">
                            <div class="text-gray-500 text-center py-4">Loading recent activity...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Request SPR Form -->
            <div id="requestForm" class="block">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-6">
                        <h2 class="text-2xl font-bold text-white">Panexpress SPR Request Form</h2>
                        <p class="text-blue-100 mt-2">Fill out the form below to create a new SPR request</p>
                    </div>

                    <form id="sprForm" class="p-8 space-y-8">
                        <!-- Section 1: Basic Information -->
                        <div class="border-b border-gray-200 pb-8">
                            <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">1</span>
                                Basic Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="sprNumber" class="block text-sm font-medium text-gray-700 mb-2">SPR Number *</label>
                                    <input type="text" id="sprNumber" name="sprNumber" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Enter SPR number">
                                </div>
                                <div>
                                    <label for="awbNumber" class="block text-sm font-medium text-gray-700 mb-2">AWB Number *</label>
                                    <input type="text" id="awbNumber" name="awbNumber" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Enter AWB number">
                                </div>
                                <div>
                                    <label for="deliveryType" class="block text-sm font-medium text-gray-700 mb-2">Delivery Type *</label>
                                    <select id="deliveryType" name="deliveryType" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                        <option value="">Select delivery type</option>
                                        <option value="Normal Delivery">Normal Delivery</option>
                                        <option value="Same Day Delivery">Same Day Delivery</option>
                                        <option value="Return">Return</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Shipment Delivery Information -->
                        <div class="border-b border-gray-200 pb-8">
                            <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">2</span>
                                Shipment Delivery Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="dataSheet" class="block text-sm font-medium text-gray-700 mb-2">Data Sheet</label>
                                    <input type="file" id="dataSheet" name="dataSheet" accept=".pdf,.doc,.docx,.xlsx,.xls"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100">
                                </div>
                                <div>
                                    <label for="qNumber" class="block text-sm font-medium text-gray-700 mb-2">Q Number</label>
                                    <input type="number" id="qNumber" name="qNumber"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Enter Q number">
                                </div>
                                <div>
                                    <label for="itemNames" class="block text-sm font-medium text-gray-700 mb-2">Item Names *</label>
                                    <div class="relative">
                                        <div id="itemNames" contenteditable="true" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors min-h-[120px] bg-white"
                                            data-placeholder="Enter item names with formatting..."
                                            style="outline: none;">
                                        </div>
                                        <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                                            <div class="flex space-x-2">
                                                <button type="button" onclick="formatText('bold')" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 font-bold">B</button>
                                                <button type="button" onclick="formatText('italic')" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 italic">I</button>
                                                <button type="button" onclick="formatText('underline')" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 underline">U</button>
                                                <button type="button" onclick="formatText('insertUnorderedList')" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-700">• List</button>
                                                <button type="button" onclick="formatText('insertOrderedList')" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-700">1. List</button>
                                            </div>
                                            <span>Rich text formatting available</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Shipment Location Information -->
                        <div class="border-b border-gray-200 pb-8">
                            <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">3</span>
                                Shipment Location Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label for="fromHub" class="block text-sm font-medium text-gray-700 mb-2">From Hub *</label>
                                    <select id="fromHub" name="fromHub" required onchange="updateHubEmail()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                        <option value="">Select hub</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="hubEmail" class="block text-sm font-medium text-gray-700 mb-2">Hub Email</label>
                                    <input type="email" id="hubEmail" name="hubEmail" readonly
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                        placeholder="Auto-filled based on hub selection">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label for="engCode" class="block text-sm font-medium text-gray-700 mb-2">Engineer Code *</label>
                                    <select id="engCode" name="engCode" required onchange="updateEngInfo()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                        <option value="">Select engineer code</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="engName" class="block text-sm font-medium text-gray-700 mb-2">Engineer Name</label>
                                    <input type="text" id="engName" name="engName" readonly
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                        placeholder="Auto-filled based on code">
                                </div>
                                <div>
                                    <label for="engMail" class="block text-sm font-medium text-gray-700 mb-2">Engineer Email</label>
                                    <input type="email" id="engMail" name="engMail" readonly
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                        placeholder="Auto-filled based on code">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                    <textarea id="location" name="location" rows="3"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Enter location information"></textarea>
                                </div>
                                <div>
                                    <label for="fullAddress" class="block text-sm font-medium text-gray-700 mb-2">Full Address</label>
                                    <textarea id="fullAddress" name="fullAddress" rows="3"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Enter full address"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Section 4: Operation Information -->
                        <div class="border-b border-gray-200 pb-8">
                            <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">4</span>
                                Operation Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="requestDateTime" class="block text-sm font-medium text-gray-700 mb-2">Request Date & Time *</label>
                                    <input type="datetime-local" id="requestDateTime" name="requestDateTime" required
                                        onchange="calculateSLA()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                                <div>
                                    <label for="plannedDateTime" class="block text-sm font-medium text-gray-700 mb-2">Planned Date & Time *</label>
                                    <input type="datetime-local" id="plannedDateTime" name="plannedDateTime" required
                                        onchange="calculateSLA()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                                <div>
                                    <label for="sla" class="block text-sm font-medium text-gray-700 mb-2">SLA</label>
                                    <input type="text" id="sla" name="sla" readonly
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                        placeholder="Auto-calculated">
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: Shipment Status -->
                        <div class="pb-8">
                            <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">5</span>
                                Shipment Status
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="shipmentStatus" class="block text-sm font-medium text-gray-700 mb-2">Shipment Status *</label>
                                    <select id="shipmentStatus" name="shipmentStatus" required onchange="updateDelayReasonAndCalculateTime()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                        <option value="">Select status</option>
                                        <option value="Postponed">Postponed</option>
                                        <option value="Delivered on Time">Delivered on Time</option>
                                        <option value="Delayed">Delayed</option>
                                        <option value="After Closing">After Closing</option>
                                        <option value="Available at another Stock">Available at another Stock</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="actualDateTime" class="block text-sm font-medium text-gray-700 mb-2">Actual Delivery Date & Time</label>
                                    <input type="datetime-local" id="actualDateTime" name="actualDateTime"
                                        onchange="updateDelayReasonAndCalculateTime()" oninput="updateDelayReasonAndCalculateTime()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                                <div>
                                    <label for="deliveryTime" class="block text-sm font-medium text-gray-700 mb-2">Delivery Time</label>
                                    <input type="text" id="deliveryTime" name="deliveryTime" readonly
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                        placeholder="Auto-calculated">
                                </div>
                            </div>
                            
                            <!-- Delay Reason Field (always visible) -->
                            <div id="delayReasonSection" class="mt-6">
                                <div class="grid grid-cols-1 gap-6">
                                    <div>
                                        <label for="delayReason" class="block text-sm font-medium text-gray-700 mb-2">Delay Reason</label>
                                        <input type="text" id="delayReason" name="delayReason" readonly
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                            placeholder="Auto-filled based on shipment status">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-between items-center">
                            <button type="button" onclick="cancelForm()" 
                                class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium transition-colors">
                                ← Cancel & Go Back
                            </button>
                            <div class="flex space-x-4">
                                <button type="button" onclick="resetForm()" 
                                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                                    Reset Form
                                </button>
                                <button type="submit" id="submitButton"
                                    class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors shadow-lg">
                                    <span id="submitText">Submit SPR Request</span>
                                    <svg id="submitSpinner" class="hidden animate-spin -mr-1 ml-3 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View SPRs Section -->
            <div id="viewSprs" class="hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-8 py-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-white">All SPR Requests - Panexpress</h2>
                                <p class="text-green-100 mt-2">View, search, and manage all submitted SPR requests</p>
                            </div>
                            <div class="flex space-x-3">
                                <button id="exportSprsBtn" onclick="dataManager.exportToCSV('sprs')" class="px-4 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium hidden">
                                    📊 Export SPRs
                                </button>
                                <button id="importSprsBtn" onclick="showImportModal()" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50 transition-colors font-medium hidden">
                                    📥 Import SPRs
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="p-8">
                        <!-- Search and Filter Controls -->
                        <div class="mb-6 flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="searchSprs" placeholder="Search by SPR Number, AWB, or Engineer Name..." 
                                    onkeyup="filterSprs()"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                            </div>
                            <div class="flex gap-2">
                                <select id="statusFilter" onchange="filterSprs()" 
                                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                </select>
                                <select id="deliveryTypeFilter" onchange="filterSprs()" 
                                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                    <option value="">All Types</option>
                                    <option value="Normal Delivery">Normal Delivery</option>
                                    <option value="Same Day Delivery">Same Day Delivery</option>
                                    <option value="Return">Return</option>
                                </select>
                            </div>
                        </div>

                        <!-- SPR List -->
                        <div id="sprList" class="space-y-4">
                            <!-- SPR items will be populated here -->
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-12 hidden">
                            <div class="text-gray-400 mb-4">
                                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No SPR Requests Found</h3>
                            <p class="text-gray-500 mb-4">No SPR requests match your current filters or none have been created yet.</p>
                            <button onclick="showRequestForm()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                Create First SPR
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management Section -->
            <div id="dataManagement" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Panexpress Data Management & Live Database</h2>
                    
                    <!-- Database Status -->
                    <div class="mb-8 p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                        <h3 class="text-lg font-semibold text-green-900 mb-4">🚀 Live Database Status</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">✅ Connected to Supabase:</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>• Real-time database operations</li>
                                    <li>• Automatic data synchronization</li>
                                    <li>• Cloud backup & recovery</li>
                                    <li>• Multi-user support ready</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">🔧 Database Info:</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>• Project: mtenuffilkhexpufgtdl</li>
                                    <li>• Region: Auto-selected</li>
                                    <li>• Status: <span class="text-green-600 font-medium">🟢 Online</span></li>
                                    <li>• Last sync: <span id="lastSyncTime">Just now</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Data Export & Import -->
                    <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-900 mb-4">📊 Data Export & Import</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                            <button onclick="dataManager.exportToCSV('sprs')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                📋 Export SPRs
                            </button>
                            <button onclick="dataManager.exportToCSV('engineers')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                👥 Export Engineers
                            </button>
                            <button onclick="dataManager.exportToCSV('hubs')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                🏢 Export Hubs
                            </button>
                            <button onclick="dataManager.exportFullBackup()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                                💾 Full Backup
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="engineerCsv" class="block text-sm font-medium text-gray-700 mb-2">Import Engineers CSV</label>
                                <input type="file" id="engineerCsv" accept=".csv" onchange="importEngineersCSV(event)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                            </div>
                            <div>
                                <label for="hubCsv" class="block text-sm font-medium text-gray-700 mb-2">Import Hubs CSV</label>
                                <input type="file" id="hubCsv" accept=".csv" onchange="importHubsCSV(event)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                            </div>
                            <div>
                                <label for="backupRestore" class="block text-sm font-medium text-gray-700 mb-2">Restore Full Backup</label>
                                <input type="file" id="backupRestore" accept=".json" onchange="handleBackupRestore(event)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-600 file:text-white hover:file:bg-green-700">
                            </div>
                        </div>
                    </div>

                    <!-- Current Data Overview -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">👥 Engineer Database</h3>
                                <span class="text-sm text-gray-600" id="engineerCount">Loading...</span>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto" id="engineerList">
                                <div class="p-4 bg-gray-100 rounded-lg text-center text-gray-500">
                                    Loading engineers from database...
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">🏢 Hub Information</h3>
                                <span class="text-sm text-gray-600" id="hubCount">Loading...</span>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto" id="hubList">
                                <div class="p-4 bg-gray-100 rounded-lg text-center text-gray-500">
                                    Loading hubs from database...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Operations -->
                    <div class="mt-8 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h3 class="text-lg font-semibold text-yellow-900 mb-4">🔧 Database Operations</h3>
                        <div class="flex space-x-4">
                            <button onclick="dataManager.refreshAllData()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                                🔄 Refresh All Data
                            </button>
                            <button onclick="downloadSampleCSV()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                📄 Download Sample CSV
                            </button>
                            <button onclick="testDatabaseConnection()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                🔍 Test Connection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ===========================================
        // DATABASE AUTHENTICATION SYSTEM
        // ===========================================
        
        let currentUser = null;
        let sessionTimeout = null;
        let authUsers = {}; // Will be loaded from database

        // Load users from database and check for existing session
        window.addEventListener('load', async function() {
            console.log('🔄 Page loaded, initializing authentication...');
            
            // Load users from database first
            await loadUsersFromDatabase();
            
            // Check for existing session
            const savedUser = localStorage.getItem('sprCurrentUser') || sessionStorage.getItem('sprCurrentUser');
            const savedTime = localStorage.getItem('sprLoginTime');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('✅ Found existing session for:', currentUser.username);
                    
                    // Check session expiry only if we have a saved time
                    if (savedTime) {
                        const loginTime = new Date(savedTime);
                        const now = new Date();
                        const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
                        
                        if (hoursSinceLogin >= 8) {
                            console.log('⏰ Session expired, logging out');
                            localStorage.removeItem('sprCurrentUser');
                            localStorage.removeItem('sprLoginTime');
                            sessionStorage.removeItem('sprCurrentUser');
                            currentUser = null;
                            return;
                        }
                    }
                    
                    // Valid session found, show main app
                    showMainApp();
                    startSessionTimeout();
                    
                } catch (error) {
                    console.error('❌ Error parsing saved user session:', error);
                    localStorage.removeItem('sprCurrentUser');
                    localStorage.removeItem('sprLoginTime');
                    sessionStorage.removeItem('sprCurrentUser');
                    currentUser = null;
                }
            } else {
                console.log('ℹ️ No existing session found, showing login screen');
            }
        });

        // Load users from Supabase database
        async function loadUsersFromDatabase() {
            try {
                console.log('🔐 Loading users from database...');
                
                // Always use fallback authentication for demo
                authUsers = {
                    'admin': {
                        password: 'admin123',
                        role: 'Administrator',
                        name: 'Admin User',
                        permissions: ['create', 'read', 'update', 'delete', 'export', 'manage']
                    },
                    'manager': {
                        password: 'manager123',
                        role: 'Manager',
                        name: 'Manager User',
                        permissions: ['create', 'read', 'update', 'export']
                    },
                    'user': {
                        password: 'user123',
                        role: 'User',
                        name: 'Standard User',
                        permissions: ['create', 'read']
                    }
                };
                
                console.log(`✅ Loaded ${Object.keys(authUsers).length} users (fallback authentication)`);
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Using fallback authentication.', 'info');
            }
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            authenticateUser(username, password, rememberMe);
        });

        async function authenticateUser(username, password, rememberMe = false) {
            const loginButton = document.getElementById('loginButton');
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            console.log('🔐 Attempting login for:', username);
            
            // Show loading state
            loginButton.disabled = true;
            loginText.textContent = 'Authenticating...';
            loginSpinner.classList.remove('hidden');
            
            try {
                // Simulate authentication delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check against database users
                if (authUsers[username] && authUsers[username].password === password) {
                    console.log('✅ Authentication successful for:', username);
                    
                    // Successful login
                    currentUser = {
                        username: username,
                        ...authUsers[username]
                    };
                    
                    console.log('💾 Saving session data...');
                    
                    // Save session - always save to both for reliability
                    const userDataString = JSON.stringify(currentUser);
                    const loginTimeString = new Date().toISOString();
                    
                    if (rememberMe) {
                        localStorage.setItem('sprCurrentUser', userDataString);
                        localStorage.setItem('sprLoginTime', loginTimeString);
                        console.log('💾 Saved to localStorage (remember me)');
                    } else {
                        sessionStorage.setItem('sprCurrentUser', userDataString);
                        console.log('💾 Saved to sessionStorage');
                    }
                    
                    // Success state
                    loginButton.classList.remove('bg-blue-600');
                    loginButton.classList.add('bg-green-600');
                    loginText.textContent = 'Login Successful!';
                    loginSpinner.classList.add('hidden');
                    
                    console.log('🚀 Showing main app...');
                    
                    // Show main app after delay
                    setTimeout(() => {
                        showMainApp();
                        startSessionTimeout();
                    }, 500); // Reduced delay
                    
                } else {
                    console.log('❌ Authentication failed for:', username);
                    throw new Error('Invalid credentials');
                }
                
            } catch (error) {
                console.error('❌ Login error:', error);
                
                // Failed login
                loginButton.disabled = false;
                loginButton.classList.remove('bg-blue-600');
                loginButton.classList.add('bg-red-600');
                loginText.textContent = 'Invalid Credentials';
                loginSpinner.classList.add('hidden');
                
                // Shake animation
                const loginContainer = document.querySelector('.max-w-md');
                if (loginContainer) {
                    loginContainer.style.animation = 'shake 0.5s ease-in-out';
                }
                
                // Reset button after delay
                setTimeout(() => {
                    loginButton.classList.remove('bg-red-600');
                    loginButton.classList.add('bg-blue-600');
                    loginText.textContent = 'Sign In';
                    if (loginContainer) {
                        loginContainer.style.animation = '';
                    }
                }, 2000);
                
                showMessage('Invalid username or password. Please try again.', 'error');
            }
        }

        function quickLogin(username, password) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            authenticateUser(username, password, false);
        }

        function showMainApp() {
            console.log('🎯 Showing main app for user:', currentUser?.username);
            
            if (!currentUser) {
                console.error('❌ No current user found, cannot show main app');
                return;
            }
            
            try {
                // Hide login screen and show main app
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                if (loginScreen && mainApp) {
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    console.log('✅ UI switched to main app');
                } else {
                    console.error('❌ Could not find login screen or main app elements');
                    return;
                }
                
                // Update user info in header
                const currentUserElement = document.getElementById('currentUser');
                const userRoleElement = document.getElementById('userRole');
                const userInitialElement = document.getElementById('userInitial');
                
                if (currentUserElement) currentUserElement.textContent = currentUser.name;
                if (userRoleElement) userRoleElement.textContent = currentUser.role;
                if (userInitialElement) userInitialElement.textContent = currentUser.name.charAt(0).toUpperCase();
                
                console.log('✅ Updated user info in header');
                
                // Show/hide admin-only features
                updateAdminFeatures();
                
                // Initialize the app
                initializeApp();
                
                // Show welcome message
                setTimeout(() => {
                    showMessage(`Welcome back, ${currentUser.name}!`, 'success');
                }, 100);
                
                console.log('✅ Main app initialization complete');
                
            } catch (error) {
                console.error('❌ Error showing main app:', error);
                // If there's an error, go back to login
                logout();
            }
        }

        function updateAdminFeatures() {
            const isAdmin = currentUser && currentUser.role === 'Administrator';
            
            // Show/hide Data Management navigation
            const dataManagementBtn = document.getElementById('dataManagementBtn');
            if (dataManagementBtn) {
                dataManagementBtn.classList.toggle('hidden', !isAdmin);
            }
            
            // Show/hide export/import buttons
            const backupBtn = document.getElementById('backupBtn');
            const exportSprsBtn = document.getElementById('exportSprsBtn');
            const importSprsBtn = document.getElementById('importSprsBtn');
            
            if (backupBtn) backupBtn.classList.toggle('hidden', !isAdmin);
            if (exportSprsBtn) exportSprsBtn.classList.toggle('hidden', !isAdmin);
            if (importSprsBtn) importSprsBtn.classList.toggle('hidden', !isAdmin);
        }

        function logout() {
            // Clear session
            localStorage.removeItem('sprCurrentUser');
            localStorage.removeItem('sprLoginTime');
            sessionStorage.removeItem('sprCurrentUser');
            
            // Clear timeout
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            
            // Reset user
            currentUser = null;
            
            // Show login screen
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset login form
            document.getElementById('loginForm').reset();
            
            // Reset login button to original state
            const loginButton = document.getElementById('loginButton');
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            if (loginButton && loginText && loginSpinner) {
                loginButton.disabled = false;
                loginButton.classList.remove('bg-green-600', 'bg-red-600');
                loginButton.classList.add('bg-blue-600');
                loginText.textContent = 'Sign In';
                loginSpinner.classList.add('hidden');
            }
            
            showMessage('You have been logged out successfully.', 'success');
        }

        function startSessionTimeout() {
            // Auto-logout after 8 hours of inactivity
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            
            sessionTimeout = setTimeout(() => {
                showMessage('Session expired. Please log in again.', 'warning');
                logout();
            }, 8 * 60 * 60 * 1000); // 8 hours
        }

        function togglePassword() {
            const passwordField = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L8.464 8.464M9.878 9.878l-1.414-1.414M14.12 14.12l1.414 1.414M14.12 14.12L15.536 15.536M14.12 14.12l1.414-1.414"></path>';
            } else {
                passwordField.type = 'password';
                eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>';
            }
        }

        function showForgotPassword() {
            showMessage('Contact your system administrator to reset your password.', 'info');
        }

        // ===========================================
        // SUPABASE CONFIGURATION & INITIALIZATION
        // ===========================================
        
        const SUPABASE_URL = 'https://mtenuffilkhexpufgtdl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10ZW51ZmZpbGtoZXhwdWZndGRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NzQxMjMsImV4cCI6MjA3NjE1MDEyM30.Y3oRMH3RKUqEzIfdVz51eB2wpuoi33HwKL74uJ-QIKE';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===========================================
        // ENHANCED DATA MANAGER - SUPABASE INTEGRATED
        // ===========================================
        
        class DataManager {
            constructor() {
                this.engineerData = {};
                this.hubData = {};
                this.sprRequests = [];
                this.isOnline = navigator.onLine;
                this.syncQueue = [];
                
                this.initializeNetworkDetection();
            }

            async initializeDatabase() {
                try {
                    console.log('🚀 Initializing Supabase connection...');
                    
                    // Test connection
                    const { data, error } = await supabase.from('engineers').select('count', { count: 'exact', head: true });
                    
                    if (error) {
                        console.error('Database connection failed:', error);
                        this.showErrorMessage('Failed to connect to database. Using offline mode.');
                        return;
                    }
                    
                    console.log('✅ Database connected successfully');
                    this.showSuccessMessage('Connected to live database!');
                    
                    // Load initial data
                    await this.loadAllData();
                    this.updateRecentActivity('Connected to live database');
                    
                } catch (error) {
                    console.error('Database initialization error:', error);
                    this.showErrorMessage('Database connection failed. Check your internet connection.');
                }
            }

            async loadAllData() {
                try {
                    // Load engineers
                    const { data: engineers, error: engError } = await supabase
                        .from('engineers')
                        .select('*')
                        .order('code');
                    
                    if (engError) throw engError;
                    
                    // Convert to object format for compatibility
                    this.engineerData = {};
                    engineers.forEach(eng => {
                        this.engineerData[eng.code] = {
                            name: eng.name,
                            email: eng.email,
                            id: eng.id,
                            createdAt: eng.created_at
                        };
                    });

                    // Load hubs
                    const { data: hubs, error: hubError } = await supabase
                        .from('hubs')
                        .select('*')
                        .order('name');
                    
                    if (hubError) throw hubError;
                    
                    // Convert to object format for compatibility
                    this.hubData = {};
                    hubs.forEach(hub => {
                        this.hubData[hub.name] = {
                            email: hub.email,
                            id: hub.id,
                            createdAt: hub.created_at
                        };
                    });

                    // Load SPR requests
                    const { data: sprs, error: sprError } = await supabase
                        .from('spr_requests')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (sprError) throw sprError;
                    
                    // Convert database format to app format
                    this.sprRequests = sprs.map(spr => ({
                        id: spr.id,
                        sprNumber: spr.spr_number,
                        awbNumber: spr.awb_number,
                        deliveryType: spr.delivery_type,
                        qNumber: spr.q_number,
                        itemNames: spr.item_names,
                        fromHub: spr.from_hub,
                        hubEmail: spr.hub_email,
                        engCode: spr.eng_code,
                        engName: spr.eng_name,
                        engMail: spr.eng_mail,
                        location: spr.location,
                        fullAddress: spr.full_address,
                        requestDateTime: spr.request_datetime,
                        plannedDateTime: spr.planned_datetime,
                        sla: spr.sla,
                        shipmentStatus: spr.shipment_status,
                        delayReason: spr.delay_reason,
                        actualDateTime: spr.actual_datetime,
                        deliveryTime: spr.delivery_time,
                        status: spr.status,
                        version: spr.version,
                        createdAt: spr.created_at,
                        updatedAt: spr.updated_at
                    }));

                    console.log(`✅ Loaded ${engineers.length} engineers, ${hubs.length} hubs, ${sprs.length} SPRs`);
                    this.refreshAllDisplays();
                    this.showDataStatus();
                    
                } catch (error) {
                    console.error('Failed to load data:', error);
                    this.showErrorMessage('Failed to load data from database');
                }
            }

            // ===========================================
            // SPR DATA OPERATIONS
            // ===========================================
            
            async createSPR(sprData) {
                try {
                    // Helper function to safely convert datetime
                    const convertDateTime = (dateTimeStr) => {
                        if (!dateTimeStr || dateTimeStr.trim() === '') return null;
                        try {
                            const date = new Date(dateTimeStr);
                            return isNaN(date.getTime()) ? null : date.toISOString();
                        } catch (error) {
                            console.warn('Invalid datetime:', dateTimeStr);
                            return null;
                        }
                    };

                    // Convert app format to database format with proper validation
                    const dbSprData = {
                        spr_number: sprData.sprNumber,
                        awb_number: sprData.awbNumber,
                        delivery_type: sprData.deliveryType,
                        q_number: sprData.qNumber ? parseInt(sprData.qNumber) : null,
                        item_names: sprData.itemNames || null,
                        from_hub: sprData.fromHub,
                        hub_email: sprData.hubEmail || null,
                        eng_code: sprData.engCode,
                        eng_name: sprData.engName || null,
                        eng_mail: sprData.engMail || null,
                        location: sprData.location || null,
                        full_address: sprData.fullAddress || null,
                        request_datetime: convertDateTime(sprData.requestDateTime),
                        planned_datetime: convertDateTime(sprData.plannedDateTime),
                        sla: sprData.sla || null,
                        shipment_status: sprData.shipmentStatus || null,
                        delay_reason: sprData.delayReason || null,
                        actual_datetime: convertDateTime(sprData.actualDateTime),
                        delivery_time: sprData.deliveryTime || null,
                        status: sprData.status || 'pending'
                    };

                    const { data, error } = await supabase
                        .from('spr_requests')
                        .insert([dbSprData])
                        .select()
                        .single();
                    
                    if (error) {
                        throw error;
                    }
                    
                    // Convert back to app format and add to local array
                    const newSpr = {
                        id: data.id,
                        sprNumber: data.spr_number,
                        awbNumber: data.awb_number,
                        deliveryType: data.delivery_type,
                        qNumber: data.q_number,
                        itemNames: data.item_names,
                        fromHub: data.from_hub,
                        hubEmail: data.hub_email,
                        engCode: data.eng_code,
                        engName: data.eng_name,
                        engMail: data.eng_mail,
                        location: data.location,
                        fullAddress: data.full_address,
                        requestDateTime: data.request_datetime,
                        plannedDateTime: data.planned_datetime,
                        sla: data.sla,
                        shipmentStatus: data.shipment_status,
                        delayReason: data.delay_reason,
                        actualDateTime: data.actual_datetime,
                        deliveryTime: data.delivery_time,
                        status: data.status,
                        version: data.version,
                        createdAt: data.created_at,
                        updatedAt: data.updated_at
                    };
                    
                    this.sprRequests.unshift(newSpr); // Add to beginning of array
                    this.showSuccessMessage('SPR created successfully in database!');
                    this.updateRecentActivity(`Created SPR #${sprData.sprNumber}`);
                    return newSpr;
                    
                } catch (error) {
                    this.handleError('Failed to create SPR', error);
                    throw error;
                }
            }

            async updateSPR(id, updates) {
                try {
                    // Helper function to safely convert datetime
                    const convertDateTime = (dateTimeStr) => {
                        if (!dateTimeStr || dateTimeStr.trim() === '') return null;
                        try {
                            const date = new Date(dateTimeStr);
                            return isNaN(date.getTime()) ? null : date.toISOString();
                        } catch (error) {
                            console.warn('Invalid datetime:', dateTimeStr);
                            return null;
                        }
                    };

                    // Convert app format to database format for updates
                    const dbUpdates = {
                        spr_number: updates.sprNumber,
                        awb_number: updates.awbNumber,
                        delivery_type: updates.deliveryType,
                        q_number: updates.qNumber ? parseInt(updates.qNumber) : null,
                        item_names: updates.itemNames || null,
                        from_hub: updates.fromHub,
                        hub_email: updates.hubEmail || null,
                        eng_code: updates.engCode,
                        eng_name: updates.engName || null,
                        eng_mail: updates.engMail || null,
                        location: updates.location || null,
                        full_address: updates.fullAddress || null,
                        request_datetime: convertDateTime(updates.requestDateTime),
                        planned_datetime: convertDateTime(updates.plannedDateTime),
                        sla: updates.sla || null,
                        shipment_status: updates.shipmentStatus || null,
                        delay_reason: updates.delayReason || null,
                        actual_datetime: convertDateTime(updates.actualDateTime),
                        delivery_time: updates.deliveryTime || null,
                        status: updates.status || 'pending'
                    };

                    const { data, error } = await supabase
                        .from('spr_requests')
                        .update(dbUpdates)
                        .eq('id', id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local array with converted data
                    const sprIndex = this.sprRequests.findIndex(spr => spr.id === id);
                    if (sprIndex !== -1) {
                        this.sprRequests[sprIndex] = {
                            id: data.id,
                            sprNumber: data.spr_number,
                            awbNumber: data.awb_number,
                            deliveryType: data.delivery_type,
                            qNumber: data.q_number,
                            itemNames: data.item_names,
                            fromHub: data.from_hub,
                            hubEmail: data.hub_email,
                            engCode: data.eng_code,
                            engName: data.eng_name,
                            engMail: data.eng_mail,
                            location: data.location,
                            fullAddress: data.full_address,
                            requestDateTime: data.request_datetime,
                            plannedDateTime: data.planned_datetime,
                            sla: data.sla,
                            shipmentStatus: data.shipment_status,
                            delayReason: data.delay_reason,
                            actualDateTime: data.actual_datetime,
                            deliveryTime: data.delivery_time,
                            status: data.status,
                            version: data.version,
                            createdAt: data.created_at,
                            updatedAt: data.updated_at
                        };
                    }
                    
                    this.showSuccessMessage('SPR updated successfully in database!');
                    this.updateRecentActivity(`Updated SPR #${this.sprRequests[sprIndex]?.sprNumber}`);
                    return this.sprRequests[sprIndex];
                    
                } catch (error) {
                    this.handleError('Failed to update SPR', error);
                    throw error;
                }
            }

            async deleteSPR(id) {
                try {
                    const spr = this.sprRequests.find(s => s.id === id);
                    if (!spr) throw new Error('SPR not found');

                    const { error } = await supabase
                        .from('spr_requests')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    // Remove from local array
                    this.sprRequests = this.sprRequests.filter(spr => spr.id !== id);
                    
                    this.showSuccessMessage('SPR deleted successfully from database!');
                    this.updateRecentActivity(`Deleted SPR #${spr.sprNumber}`);
                    
                } catch (error) {
                    this.handleError('Failed to delete SPR', error);
                    throw error;
                }
            }

            // ===========================================
            // ENGINEER & HUB OPERATIONS
            // ===========================================
            
            async addEngineer(code, name, email) {
                try {
                    const { data, error } = await supabase
                        .from('engineers')
                        .insert([{ code, name, email }])
                        .select()
                        .single();
                    
                    if (error) {
                        if (error.code === '23505') {
                            throw new Error('Engineer code already exists');
                        }
                        throw error;
                    }
                    
                    this.engineerData[code] = {
                        name,
                        email,
                        id: data.id,
                        createdAt: data.created_at
                    };
                    
                    this.updateRecentActivity(`Added engineer ${code}`);
                    return data;
                    
                } catch (error) {
                    this.handleError('Failed to add engineer', error);
                    throw error;
                }
            }

            async addHub(name, email) {
                try {
                    const { data, error } = await supabase
                        .from('hubs')
                        .insert([{ name, email }])
                        .select()
                        .single();
                    
                    if (error) {
                        if (error.code === '23505') {
                            throw new Error('Hub name already exists');
                        }
                        throw error;
                    }
                    
                    this.hubData[name] = {
                        email,
                        id: data.id,
                        createdAt: data.created_at
                    };
                    
                    this.updateRecentActivity(`Added hub ${name}`);
                    return data;
                    
                } catch (error) {
                    this.handleError('Failed to add hub', error);
                    throw error;
                }
            }

            // ===========================================
            // DATA EXPORT & BACKUP
            // ===========================================
            
            exportToCSV(dataType = 'sprs') {
                try {
                    let csvContent = '';
                    let filename = '';
                    
                    if (dataType === 'sprs') {
                        csvContent = this.generateSPRsCSV();
                        filename = `SPR_Export_${this.formatDateForFilename()}.csv`;
                    } else if (dataType === 'engineers') {
                        csvContent = this.generateEngineersCSV();
                        filename = `Engineers_Export_${this.formatDateForFilename()}.csv`;
                    } else if (dataType === 'hubs') {
                        csvContent = this.generateHubsCSV();
                        filename = `Hubs_Export_${this.formatDateForFilename()}.csv`;
                    }
                    
                    this.downloadFile(csvContent, filename, 'text/csv');
                    this.showSuccessMessage(`${dataType.toUpperCase()} data exported successfully!`);
                    this.updateRecentActivity(`Exported ${dataType} data`);
                } catch (error) {
                    this.handleError('Failed to export data', error);
                }
            }

            exportFullBackup() {
                try {
                    const backupData = {
                        version: '33.0',
                        exportDate: new Date().toISOString(),
                        source: 'supabase',
                        data: {
                            sprRequests: this.sprRequests,
                            engineerData: this.engineerData,
                            hubData: this.hubData
                        },
                        metadata: {
                            totalSPRs: this.sprRequests.length,
                            totalEngineers: Object.keys(this.engineerData).length,
                            totalHubs: Object.keys(this.hubData).length,
                            databaseUrl: SUPABASE_URL
                        }
                    };
                    
                    const jsonContent = JSON.stringify(backupData, null, 2);
                    const filename = `SPR_Database_Backup_v33_${this.formatDateForFilename()}.json`;
                    
                    this.downloadFile(jsonContent, filename, 'application/json');
                    this.showSuccessMessage('Database backup created successfully!');
                    this.updateRecentActivity('Created database backup');
                } catch (error) {
                    this.handleError('Failed to create backup', error);
                }
            }

            // ===========================================
            // UTILITY & HELPER FUNCTIONS
            // ===========================================
            
            async refreshAllData() {
                try {
                    this.showMessage('Refreshing data from database...', 'info');
                    await this.loadAllData();
                    this.showSuccessMessage('Data refreshed successfully!');
                    this.updateRecentActivity('Refreshed all data from database');
                    document.getElementById('lastSyncTime').textContent = new Date().toLocaleTimeString('en-GB', { hour12: false });
                } catch (error) {
                    this.handleError('Failed to refresh data', error);
                }
            }

            async syncPendingChanges() {
                // For live database, this just refreshes data
                await this.refreshAllData();
            }

            initializeNetworkDetection() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showSuccessMessage('Connection restored! Refreshing data...');
                    this.refreshAllData();
                    this.showDataStatus();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showWarningMessage('Connection lost. Some features may be limited.');
                    this.showDataStatus();
                });
            }

            showDataStatus() {
                const statusElement = document.getElementById('dataStatus');
                if (!statusElement) return;
                
                const statusText = this.isOnline ? 'Connected to Supabase' : 'Offline - Limited functionality';
                const statusColor = this.isOnline ? 'text-green-600' : 'text-red-600';
                const dotColor = this.isOnline ? 'bg-green-500' : 'bg-red-500';
                
                statusElement.innerHTML = `
                    <div class="flex items-center ${statusColor}">
                        <div class="w-2 h-2 rounded-full ${dotColor} mr-2 pulse-dot"></div>
                        ${statusText}
                    </div>
                `;
            }

            updateRecentActivity(activity) {
                const recentActivityElement = document.getElementById('recentActivity');
                if (!recentActivityElement) return;

                const activityItem = document.createElement('div');
                activityItem.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200';
                activityItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full bg-blue-500 mr-3"></div>
                        <span class="text-sm text-gray-700">${activity}</span>
                    </div>
                    <span class="text-xs text-gray-500">${new Date().toLocaleTimeString('en-GB', { hour12: false })}</span>
                `;

                // Clear loading message if present
                if (recentActivityElement.firstChild && recentActivityElement.firstChild.textContent.includes('Loading')) {
                    recentActivityElement.innerHTML = '';
                }
                
                recentActivityElement.insertBefore(activityItem, recentActivityElement.firstChild);
                
                // Keep only last 5 activities
                while (recentActivityElement.children.length > 5) {
                    recentActivityElement.removeChild(recentActivityElement.lastChild);
                }
            }

            // CSV Generation Methods
            generateSPRsCSV() {
                const headers = [
                    'SPR Number', 'AWB Number', 'Delivery Type', 'Q Number', 'Item Names',
                    'From Hub', 'Hub Email', 'Engineer Code', 'Engineer Name', 'Engineer Email',
                    'Location', 'Full Address', 'Request DateTime', 'Planned DateTime', 'SLA',
                    'Shipment Status', 'Delay Reason', 'Actual DateTime', 'Delivery Time',
                    'Status', 'Created At', 'Updated At', 'Version'
                ];
                
                const rows = this.sprRequests.map(spr => [
                    spr.sprNumber, spr.awbNumber, spr.deliveryType, spr.qNumber, spr.itemNames,
                    spr.fromHub, spr.hubEmail, spr.engCode, spr.engName, spr.engMail,
                    spr.location, spr.fullAddress, spr.requestDateTime, spr.plannedDateTime, spr.sla,
                    spr.shipmentStatus, spr.delayReason, spr.actualDateTime, spr.deliveryTime,
                    spr.status, spr.createdAt, spr.updatedAt, spr.version
                ]);
                
                return [headers, ...rows].map(row => 
                    row.map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(',')
                ).join('\n');
            }

            generateEngineersCSV() {
                const headers = ['Code', 'Name', 'Email', 'Created At'];
                const rows = Object.entries(this.engineerData).map(([code, data]) => [
                    code, data.name, data.email, data.createdAt || ''
                ]);
                
                return [headers, ...rows].map(row => 
                    row.map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',')
                ).join('\n');
            }

            generateHubsCSV() {
                const headers = ['Name', 'Email', 'Created At'];
                const rows = Object.entries(this.hubData).map(([name, data]) => [
                    name, data.email, data.createdAt || ''
                ]);
                
                return [headers, ...rows].map(row => 
                    row.map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',')
                ).join('\n');
            }

            // Utility methods
            formatDateForFilename() {
                return new Date().toISOString().split('T')[0].replace(/-/g, '');
            }

            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                window.URL.revokeObjectURL(url);
            }

            refreshAllDisplays() {
                if (typeof updateEngineerDropdown === 'function') updateEngineerDropdown();
                if (typeof updateHubDropdown === 'function') updateHubDropdown();
                if (typeof displayEngineers === 'function') displayEngineers();
                if (typeof displayHubs === 'function') displayHubs();
                if (typeof displaySprs === 'function') displaySprs();
                if (typeof updateDashboardStats === 'function') updateDashboardStats();
            }

            showSuccessMessage(message) {
                this.showMessage(message, 'success');
            }

            showWarningMessage(message) {
                this.showMessage(message, 'warning');
            }

            showErrorMessage(message) {
                this.showMessage(message, 'error');
            }

            showMessage(message, type = 'success') {
                const colors = {
                    success: 'bg-green-500',
                    warning: 'bg-yellow-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500'
                };
                
                const icons = {
                    success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                    warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>',
                    error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
                    info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                };
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in`;
                messageDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${icons[type]}
                        </svg>
                        ${message}
                    </div>
                `;
                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    messageDiv.remove();
                }, type === 'error' ? 5000 : 3000);
            }

            handleError(message, error) {
                console.error(message, error);
                this.showErrorMessage(`${message}: ${error.message}`);
                this.updateRecentActivity(`Error: ${message}`);
            }
        }

        // Initialize Enhanced Data Manager with Supabase
        let dataManager;

        // Legacy compatibility
        let engineerData = {};
        let hubData = {};
        let sprRequests = [];

        // Date formatting functions
        function formatDateTime(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function formatDateTime24(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleString('en-GB', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function initializeApp() {
            dataManager = new DataManager();
            dataManager.initializeDatabase();
            
            // Update legacy references
            engineerData = dataManager.engineerData;
            hubData = dataManager.hubData;
            sprRequests = dataManager.sprRequests;
            
            // Initialize displays
            setTimeout(() => {
                updateDashboardStats();
                displayEngineers();
                displayHubs();
                updateEngineerDropdown();
                updateHubDropdown();
            }, 2000);
        }

        // ===========================================
        // NAVIGATION FUNCTIONS
        // ===========================================
        
        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboard').classList.remove('hidden');
            updateDashboardStats();
            updateNavigation('dashboard');
        }

        function showRequestForm() {
            hideAllSections();
            document.getElementById('requestForm').classList.remove('hidden');
            updateNavigation('request');
            
            // Set default date times after form is visible
            setTimeout(setDefaultDateTimes, 100);
        }

        // Set current date and time as default when form loads
        function setDefaultDateTimes() {
            const now = new Date();
            const currentDateTime = now.toISOString().slice(0, 16);
            
            const requestField = document.getElementById('requestDateTime');
            const plannedField = document.getElementById('plannedDateTime');
            
            if (requestField && !requestField.value) {
                requestField.value = currentDateTime;
            }
            
            if (plannedField && !plannedField.value) {
                // Set planned time to 2 hours from now as default
                const plannedTime = new Date(now.getTime() + 2 * 60 * 60 * 1000);
                plannedField.value = plannedTime.toISOString().slice(0, 16);
            }
            
            // Calculate SLA if both fields have values
            calculateSLA();
        }

        function showViewSprs() {
            hideAllSections();
            document.getElementById('viewSprs').classList.remove('hidden');
            updateNavigation('viewsprs');
            displaySprs();
        }

        function showDataManagement() {
            hideAllSections();
            document.getElementById('dataManagement').classList.remove('hidden');
            updateNavigation('data');
            displayEngineers();
            displayHubs();
        }

        function hideAllSections() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('requestForm').classList.add('hidden');
            document.getElementById('viewSprs').classList.add('hidden');
            document.getElementById('dataManagement').classList.add('hidden');
        }

        function updateNavigation(active) {
            const buttons = document.querySelectorAll('nav button');
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            if (active === 'request') {
                buttons[1].classList.add('bg-blue-600', 'text-white');
                buttons[1].classList.remove('text-gray-600');
            }
        }

        // ===========================================
        // RICH TEXT EDITOR FUNCTIONS
        // ===========================================
        
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('itemNames').focus();
        }

        // Add placeholder styling for rich text editor
        document.addEventListener('DOMContentLoaded', function() {
            const itemNamesEditor = document.getElementById('itemNames');
            if (itemNamesEditor) {
                // Handle placeholder
                itemNamesEditor.addEventListener('focus', function() {
                    if (this.innerHTML === '' || this.innerHTML === '<br>') {
                        this.innerHTML = '';
                    }
                });
                
                itemNamesEditor.addEventListener('blur', function() {
                    if (this.innerHTML === '' || this.innerHTML === '<br>') {
                        this.innerHTML = '';
                    }
                });
                
                // Add placeholder styling
                const style = document.createElement('style');
                style.textContent = `
                    #itemNames:empty:before {
                        content: attr(data-placeholder);
                        color: #9CA3AF;
                        font-style: italic;
                    }
                    #itemNames:focus:empty:before {
                        content: '';
                    }
                `;
                document.head.appendChild(style);
            }
        });

        // ===========================================
        // FORM FUNCTIONS
        // ===========================================
        
        function updateHubEmail() {
            const hubSelect = document.getElementById('fromHub');
            const hubEmailInput = document.getElementById('hubEmail');
            
            if (hubSelect.value && dataManager.hubData[hubSelect.value]) {
                hubEmailInput.value = dataManager.hubData[hubSelect.value].email;
            } else {
                hubEmailInput.value = '';
            }
        }

        function updateEngInfo() {
            const engCodeSelect = document.getElementById('engCode');
            const engNameInput = document.getElementById('engName');
            const engMailInput = document.getElementById('engMail');
            
            const selectedCode = engCodeSelect.value;
            
            if (selectedCode && dataManager.engineerData[selectedCode]) {
                engNameInput.value = dataManager.engineerData[selectedCode].name;
                engMailInput.value = dataManager.engineerData[selectedCode].email;
            } else {
                engNameInput.value = '';
                engMailInput.value = '';
            }
        }

        function toggleDelayReason() {
            const shipmentStatus = document.getElementById('shipmentStatus').value;
            const delayReasonField = document.getElementById('delayReason');
            
            const statusesRequiringReason = ['Postponed', 'After Closing', 'Available at another Stock', 'Delayed'];
            
            if (statusesRequiringReason.includes(shipmentStatus)) {
                delayReasonField.value = shipmentStatus;
                delayReasonField.classList.remove('bg-gray-50');
                delayReasonField.classList.add('bg-yellow-50', 'border-yellow-300');
            } else if (shipmentStatus === 'Delivered on Time') {
                delayReasonField.value = 'No Delay - Delivered on Time';
                delayReasonField.classList.remove('bg-gray-50', 'bg-yellow-50', 'border-yellow-300');
                delayReasonField.classList.add('bg-green-50', 'border-green-300');
            } else {
                delayReasonField.value = '';
                delayReasonField.classList.remove('bg-yellow-50', 'border-yellow-300', 'bg-green-50', 'border-green-300');
                delayReasonField.classList.add('bg-gray-50');
            }
        }

        function calculateSLA() {
            const requestDateTime = document.getElementById('requestDateTime').value;
            const plannedDateTime = document.getElementById('plannedDateTime').value;
            const slaField = document.getElementById('sla');
            
            if (requestDateTime && plannedDateTime) {
                const requestDate = new Date(requestDateTime);
                const plannedDate = new Date(plannedDateTime);
                const diffMs = plannedDate - requestDate;
                
                if (diffMs >= 0) {
                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    slaField.value = `${hours} Hours ${minutes} Mins`;
                } else {
                    slaField.value = 'Invalid: Planned time is before request time';
                }
            } else {
                slaField.value = '';
            }
        }

        function calculateDeliveryTime() {
            const requestDateTime = document.getElementById('requestDateTime').value;
            const actualDateTime = document.getElementById('actualDateTime').value;
            const deliveryTimeField = document.getElementById('deliveryTime');
            
            if (requestDateTime && actualDateTime) {
                const requestDate = new Date(requestDateTime);
                const actualDate = new Date(actualDateTime);
                const diffMs = actualDate - requestDate;
                
                if (diffMs >= 0) {
                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    deliveryTimeField.value = `${hours} Hours ${minutes} Mins`;
                } else {
                    deliveryTimeField.value = 'Invalid: Actual time is before request time';
                }
            } else {
                deliveryTimeField.value = '';
            }
        }

        function updateDelayReasonAndCalculateTime() {
            // Update delay reason based on shipment status
            toggleDelayReason();
            
            // Recalculate delivery time if actual date is set
            calculateDeliveryTime();
        }

        function resetForm() {
            document.getElementById('sprForm').reset();
            document.getElementById('hubEmail').value = '';
            document.getElementById('engName').value = '';
            document.getElementById('engMail').value = '';
            document.getElementById('sla').value = '';
            document.getElementById('deliveryTime').value = '';
            document.getElementById('delayReason').value = '';
            document.getElementById('itemNames').innerHTML = '';
        }

        function cancelForm() {
            // Reset form and go back to dashboard or view SPRs
            resetForm();
            
            // Clear edit mode if active
            const form = document.getElementById('sprForm');
            form.removeAttribute('data-edit-id');
            
            // Reset form title
            const formTitle = document.querySelector('#requestForm h2');
            if (formTitle) {
                formTitle.textContent = 'Panexpress SPR Request Form';
            }
            
            // Reset button text
            const submitText = document.getElementById('submitText');
            if (submitText) {
                submitText.textContent = 'Submit SPR Request';
            }
            
            // Go to dashboard or view SPRs based on user preference
            if (dataManager && dataManager.sprRequests.length > 0) {
                showViewSprs();
                showMessage('Form cancelled. Returned to SPR list.', 'info');
            } else {
                showDashboard();
                showMessage('Form cancelled. Returned to dashboard.', 'info');
            }
        }

        // ===========================================
        // FORM SUBMISSION
        // ===========================================
        
        document.getElementById('sprForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            const editId = this.getAttribute('data-edit-id');
            const isEditing = !!editId;
            
            try {
                // Show loading state
                submitButton.disabled = true;
                submitText.textContent = isEditing ? 'Updating SPR...' : 'Creating SPR...';
                submitSpinner.classList.remove('hidden');
                
                const formData = new FormData(this);
                const sprData = {
                    sprNumber: formData.get('sprNumber'),
                    awbNumber: formData.get('awbNumber'),
                    deliveryType: formData.get('deliveryType'),
                    qNumber: formData.get('qNumber'),
                    itemNames: document.getElementById('itemNames').innerHTML || '',
                    fromHub: formData.get('fromHub'),
                    hubEmail: formData.get('hubEmail'),
                    engCode: formData.get('engCode'),
                    engName: formData.get('engName'),
                    engMail: formData.get('engMail'),
                    location: formData.get('location'),
                    fullAddress: formData.get('fullAddress'),
                    requestDateTime: formData.get('requestDateTime'),
                    plannedDateTime: formData.get('plannedDateTime'),
                    sla: formData.get('sla'),
                    shipmentStatus: formData.get('shipmentStatus'),
                    delayReason: formData.get('delayReason') || '',
                    actualDateTime: formData.get('actualDateTime'),
                    deliveryTime: formData.get('deliveryTime'),
                    status: isEditing ? (formData.get('status') || 'pending') : 'pending'
                };

                // Validate required fields (mandatory inputs only)
                const requiredFields = {
                    'sprNumber': 'SPR Number',
                    'awbNumber': 'AWB Number', 
                    'deliveryType': 'Delivery Type',
                    'fromHub': 'From Hub',
                    'engCode': 'Engineer Code',
                    'itemNames': 'Item Names',
                    'requestDateTime': 'Request Date & Time',
                    'plannedDateTime': 'Planned Date & Time',
                    'shipmentStatus': 'Shipment Status'
                };
                
                const missingFields = [];
                Object.keys(requiredFields).forEach(field => {
                    if (!sprData[field] || sprData[field].toString().trim() === '') {
                        missingFields.push(requiredFields[field]);
                    }
                });
                
                if (missingFields.length > 0) {
                    throw new Error(`Please fill in required fields: ${missingFields.join(', ')}`);
                }

                // Validate SPR Number format
                if (!sprData.sprNumber || sprData.sprNumber.trim() === '') {
                    throw new Error('SPR Number is required');
                }
                
                // Validate AWB Number
                if (!sprData.awbNumber || sprData.awbNumber.trim() === '') {
                    throw new Error('AWB Number is required');
                }
                
                // Note: SPR numbers are allowed to be duplicates - no uniqueness check

                // Create or update SPR in database
                if (isEditing) {
                    await dataManager.updateSPR(editId, sprData);
                } else {
                    await dataManager.createSPR(sprData);
                }
                
                // Update local references for compatibility
                sprRequests = dataManager.sprRequests;
                
                // Success state
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitButton.classList.add('bg-green-600');
                submitText.textContent = isEditing ? 'SPR Updated Successfully!' : 'SPR Created Successfully!';
                submitSpinner.classList.add('hidden');
                
                // Reset after delay
                setTimeout(() => {
                    updateDashboardStats();
                    resetForm();
                    
                    // Reset form title and button
                    const formTitle = document.querySelector('#requestForm h2');
                    if (formTitle) {
                        formTitle.textContent = 'Panexpress SPR Request Form';
                    }
                    
                    // Clear edit mode
                    this.removeAttribute('data-edit-id');
                    
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.classList.remove('bg-green-600');
                    submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    submitText.textContent = 'Submit SPR Request';
                    
                    // Go back to view SPRs if we were editing
                    if (isEditing) {
                        showViewSprs();
                    }
                }, 2000);
                
            } catch (error) {
                // Error state
                submitButton.disabled = false;
                submitButton.classList.remove('bg-blue-600');
                submitButton.classList.add('bg-red-600');
                submitText.textContent = 'Error - Try Again';
                submitSpinner.classList.add('hidden');
                
                dataManager.handleError(isEditing ? 'Failed to update SPR' : 'Failed to submit SPR', error);
                
                // Reset button after delay
                setTimeout(() => {
                    submitButton.classList.remove('bg-red-600');
                    submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    submitText.textContent = isEditing ? 'Update SPR' : 'Submit SPR Request';
                }, 3000);
            }
        });

        // ===========================================
        // DATA DISPLAY FUNCTIONS
        // ===========================================
        
        function updateDashboardStats() {
            if (!dataManager) return;
            document.getElementById('totalSprs').textContent = dataManager.sprRequests.length;
            document.getElementById('completedSprs').textContent = dataManager.sprRequests.filter(spr => spr.status === 'completed').length;
            document.getElementById('pendingSprs').textContent = dataManager.sprRequests.filter(spr => spr.status === 'pending').length;
        }

        function displaySprs() {
            if (!dataManager) return;
            
            const sprList = document.getElementById('sprList');
            const emptyState = document.getElementById('emptyState');
            
            if (dataManager.sprRequests.length === 0) {
                sprList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            const sprHtml = dataManager.sprRequests.map(spr => `
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200 hover:shadow-md transition-shadow" data-spr-id="${spr.id}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">SPR #${spr.sprNumber}</h3>
                            <p class="text-sm text-gray-600">AWB: ${spr.awbNumber}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${spr.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${spr.status === 'completed' ? 'Completed' : 'Pending'}
                            </span>
                            <span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">v33</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Delivery Type</p>
                            <p class="text-sm font-medium text-gray-900">${spr.deliveryType || 'Not specified'}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Engineer</p>
                            <p class="text-sm font-medium text-gray-900">${spr.engName || 'Not assigned'} (${spr.engCode || 'N/A'})</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Hub</p>
                            <p class="text-sm font-medium text-gray-900">${spr.fromHub || 'Not specified'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Request Date</p>
                            <p class="text-sm font-medium text-gray-900">${formatDateTime24(spr.requestDateTime)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Planned Date</p>
                            <p class="text-sm font-medium text-gray-900">${formatDateTime24(spr.plannedDateTime)}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-500">
                            Created: ${formatDateTime24(spr.createdAt)}
                        </div>
                    </div>
                </div>
            `).join('');
            
            sprList.innerHTML = sprHtml;
        }

        function displayEngineers() {
            if (!dataManager) return;
            
            const engineerList = document.getElementById('engineerList');
            const engineerCount = document.getElementById('engineerCount');
            
            if (!engineerList || !engineerCount) return;
            
            const engineers = Object.entries(dataManager.engineerData);
            engineerCount.textContent = `${engineers.length} engineers`;
            
            if (engineers.length === 0) {
                engineerList.innerHTML = '<div class="p-4 bg-gray-100 rounded-lg text-center text-gray-500">No engineers found</div>';
                return;
            }
            
            const engineerHtml = engineers.map(([code, data]) => `
                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${code}</h4>
                            <p class="text-sm text-gray-600">${data.name}</p>
                            <p class="text-xs text-gray-500">${data.email}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            engineerList.innerHTML = engineerHtml;
        }

        function displayHubs() {
            if (!dataManager) return;
            
            const hubList = document.getElementById('hubList');
            const hubCount = document.getElementById('hubCount');
            
            if (!hubList || !hubCount) return;
            
            const hubs = Object.entries(dataManager.hubData);
            hubCount.textContent = `${hubs.length} hubs`;
            
            if (hubs.length === 0) {
                hubList.innerHTML = '<div class="p-4 bg-gray-100 rounded-lg text-center text-gray-500">No hubs found</div>';
                return;
            }
            
            const hubHtml = hubs.map(([name, data]) => `
                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${name}</h4>
                            <p class="text-sm text-gray-600">${data.email}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            hubList.innerHTML = hubHtml;
        }

        function updateEngineerDropdown() {
            if (!dataManager) return;
            
            const engCodeSelect = document.getElementById('engCode');
            if (!engCodeSelect) return;
            
            // Clear existing options except the first one
            engCodeSelect.innerHTML = '<option value="">Select engineer code</option>';
            
            // Add engineer options
            Object.entries(dataManager.engineerData).forEach(([code, data]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${data.name}`;
                engCodeSelect.appendChild(option);
            });
        }

        function updateHubDropdown() {
            if (!dataManager) return;
            
            const hubSelect = document.getElementById('fromHub');
            if (!hubSelect) return;
            
            // Clear existing options except the first one
            hubSelect.innerHTML = '<option value="">Select hub</option>';
            
            // Add hub options
            Object.keys(dataManager.hubData).forEach(hubName => {
                const option = document.createElement('option');
                option.value = hubName;
                option.textContent = hubName;
                hubSelect.appendChild(option);
            });
        }

        function filterSprs() {
            // Implement SPR filtering functionality
            console.log('Filtering SPRs...');
        }

        function showMessage(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>',
                error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
                info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in`;
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${icons[type]}
                    </svg>
                    ${message}
                </div>
            `;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, type === 'error' ? 5000 : 3000);
        }

        // ===========================================
        // CSV IMPORT FUNCTIONS
        // ===========================================
        
        async function importEngineersCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                showMessage('Importing engineers...', 'info');
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('CSV file must have at least a header row and one data row');
                }
                
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
                console.log('CSV Headers:', headers);
                
                // Find column indices
                const codeIndex = headers.findIndex(h => h.includes('code') || h === 'engineer code' || h === 'eng code');
                const nameIndex = headers.findIndex(h => h.includes('name') || h === 'engineer name');
                const emailIndex = headers.findIndex(h => h.includes('email') || h.includes('mail'));
                
                if (codeIndex === -1 || nameIndex === -1 || emailIndex === -1) {
                    throw new Error('CSV must contain Code, Name, and Email columns');
                }
                
                let imported = 0;
                let skipped = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Better CSV parsing to handle commas in quoted fields
                    const values = parseCSVLine(line);
                    
                    if (values.length > Math.max(codeIndex, nameIndex, emailIndex)) {
                        const code = values[codeIndex]?.trim();
                        const name = values[nameIndex]?.trim();
                        const email = values[emailIndex]?.trim();
                        
                        if (code && name && email) {
                            try {
                                await dataManager.addEngineer(code, name, email);
                                imported++;
                                console.log(`Imported engineer: ${code} - ${name}`);
                            } catch (error) {
                                console.warn(`Failed to import engineer ${code}:`, error.message);
                                skipped++;
                            }
                        } else {
                            console.warn(`Skipping row ${i}: missing required data`, { code, name, email });
                            skipped++;
                        }
                    } else {
                        console.warn(`Skipping row ${i}: insufficient columns`);
                        skipped++;
                    }
                }
                
                // Refresh displays
                await dataManager.loadAllData();
                displayEngineers();
                updateEngineerDropdown();
                
                const message = `Import complete! ${imported} engineers imported${skipped > 0 ? `, ${skipped} skipped` : ''}`;
                showMessage(message, 'success');
                
            } catch (error) {
                console.error('Import error:', error);
                showMessage(`Import failed: ${error.message}`, 'error');
            }
            
            event.target.value = '';
        }

        async function importHubsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                showMessage('Importing hubs...', 'info');
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('CSV file must have at least a header row and one data row');
                }
                
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
                console.log('CSV Headers:', headers);
                
                // Find column indices
                const nameIndex = headers.findIndex(h => h.includes('name') || h === 'hub name' || h === 'hub');
                const emailIndex = headers.findIndex(h => h.includes('email') || h.includes('mail'));
                
                if (nameIndex === -1 || emailIndex === -1) {
                    throw new Error('CSV must contain Name and Email columns');
                }
                
                let imported = 0;
                let skipped = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Better CSV parsing to handle commas in quoted fields
                    const values = parseCSVLine(line);
                    
                    if (values.length > Math.max(nameIndex, emailIndex)) {
                        const name = values[nameIndex]?.trim();
                        const email = values[emailIndex]?.trim();
                        
                        if (name && email) {
                            try {
                                await dataManager.addHub(name, email);
                                imported++;
                                console.log(`Imported hub: ${name}`);
                            } catch (error) {
                                console.warn(`Failed to import hub ${name}:`, error.message);
                                skipped++;
                            }
                        } else {
                            console.warn(`Skipping row ${i}: missing required data`, { name, email });
                            skipped++;
                        }
                    } else {
                        console.warn(`Skipping row ${i}: insufficient columns`);
                        skipped++;
                    }
                }
                
                // Refresh displays
                await dataManager.loadAllData();
                displayHubs();
                updateHubDropdown();
                
                const message = `Import complete! ${imported} hubs imported${skipped > 0 ? `, ${skipped} skipped` : ''}`;
                showMessage(message, 'success');
                
            } catch (error) {
                console.error('Import error:', error);
                showMessage(`Import failed: ${error.message}`, 'error');
            }
            
            event.target.value = '';
        }

        // Helper function to properly parse CSV lines with quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim());
            
            return result;
        }

        function downloadSampleCSV() {
            const engineerCSV = 'Code,Name,Email\nENG001,John Smith,john.smith@panexpress.com\nENG002,Jane Doe,jane.doe@panexpress.com';
            const hubCSV = 'Name,Email\nMain Hub,main@panexpress.com\nSecondary Hub,secondary@panexpress.com';
            
            // Create a zip-like structure by downloading both files
            dataManager.downloadFile(engineerCSV, 'sample_engineers.csv', 'text/csv');
            setTimeout(() => {
                dataManager.downloadFile(hubCSV, 'sample_hubs.csv', 'text/csv');
            }, 1000);
            
            dataManager.showSuccessMessage('Sample CSV files downloaded!');
        }

        async function testDatabaseConnection() {
            try {
                dataManager.showMessage('Testing database connection...', 'info');
                
                const { data, error } = await supabase.from('engineers').select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                dataManager.showSuccessMessage('Database connection test successful!');
                dataManager.updateRecentActivity('Database connection test passed');
                
            } catch (error) {
                dataManager.handleError('Database connection test failed', error);
            }
        }

        async function handleBackupRestore(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                if (!backupData.data || !backupData.data.sprRequests) {
                    throw new Error('Invalid backup file format');
                }
                
                // This would require careful implementation to restore data
                dataManager.showMessage('Backup restore feature is under development', 'info');
                
            } catch (error) {
                dataManager.handleError('Failed to restore backup', error);
            }
            
            event.target.value = '';
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fa6bd0f664536e',t:'MTc2MDY0Nzc0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
